# Circular Protocol Canonical - Regression Test Generator
# Generates breaking change detection script
# Input: tests/L4-regression/regression-tests.test.ncl
# Output: dist/tests/detect-breaking-changes.sh

let config = import "../../../src/config.ncl" in
let test_spec = import "../../../tests/L4-regression/regression-tests.test.ncl" in

# Generate breaking change detection rules
let breaking_rules = std.record.fields test_spec.breaking_changes in
let breaking_rule_list = std.array.map (fun rule_name =>
  let rule = std.record.get rule_name test_spec.breaking_changes in
  m%"'%{rule.rule}'"%
) breaking_rules in

# Main regression test script
{
  regression_script = m%"
#!/usr/bin/env bash
# Regression Test - Breaking Change Detection
# Generated from generators/shared/test-runners/regression-validator.ncl
#
# ⚠️  DO NOT EDIT THIS FILE MANUALLY
# To modify, edit the generator and regenerate
#
# Purpose: Detects breaking changes between current and previous API versions
# Method: Compares OpenAPI specs, categorizes changes as breaking/non-breaking

set -euo pipefail

# Colors
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
BLUE='\\033[0;34m'
NC='\\033[0m'

log_section() {
    echo ""
    echo -e "${YELLOW}═══════════════════════════════════════════════════════${NC}"
    echo -e "${YELLOW}  $1${NC}"
    echo -e "${YELLOW}═══════════════════════════════════════════════════════${NC}"
    echo ""
}

log_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

log_error() {
    echo -e "${RED}❌ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

log_info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

cd "$PROJECT_ROOT"

log_section '%{test_spec.test_suite_name}'
echo "Version: %{config.version}"
echo ""

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_warning "Not a git repository"
    echo "  Regression tests require git history"
    echo "  Skipping regression tests"
    exit 0
fi

# Get previous version tag
PREVIOUS_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

if [ -z "$PREVIOUS_TAG" ]; then
    log_warning "No previous version tag found"
    echo "  This is likely the first version"
    echo "  Skipping regression tests"
    exit 0
fi

log_info "Comparing against: $PREVIOUS_TAG"
log_info "Current version: %{config.version}"

# Generate current OpenAPI spec
log_section "Phase 1: Generate Current API Specification"

if [ ! -f "generators/shared/openapi.ncl" ]; then
    log_error "generators/shared/openapi.ncl not found"
    echo "  Cannot perform regression testing without OpenAPI generator"
    exit 1
fi

log_info "Generating current OpenAPI spec..."
if ! nickel export generators/shared/openapi.ncl --format yaml > /tmp/openapi-current.yaml 2>&1; then
    log_error "Failed to generate current OpenAPI spec"
    exit 1
fi
log_success "Current spec generated"

# Create worktree for previous version
log_section "Phase 2: Generate Previous API Specification"

log_info "Checking out previous version ($PREVIOUS_TAG)..."

# Clean up any existing worktree
git worktree remove /tmp/canonical-previous 2>/dev/null || true
rm -rf /tmp/canonical-previous

if ! git worktree add /tmp/canonical-previous $PREVIOUS_TAG 2>&1; then
    log_error "Could not create worktree for previous version"
    rm -f /tmp/openapi-current.yaml
    exit 1
fi

log_info "Generating previous OpenAPI spec..."
if [ ! -f "/tmp/canonical-previous/generators/shared/openapi.ncl" ]; then
    log_warning "Previous version has no OpenAPI generator"
    echo "  Cannot compare - previous version uses different structure"
    git worktree remove /tmp/canonical-previous 2>/dev/null
    rm -f /tmp/openapi-current.yaml
    exit 0
fi

if ! (cd /tmp/canonical-previous && nickel export generators/shared/openapi.ncl --format yaml > /tmp/openapi-previous.yaml 2>&1); then
    log_error "Failed to generate previous OpenAPI spec"
    git worktree remove /tmp/canonical-previous 2>/dev/null
    rm -f /tmp/openapi-current.yaml
    exit 1
fi
log_success "Previous spec generated"

# Compare specifications
log_section "Phase 3: Detecting Changes"

BREAKING_CHANGES=()
NON_BREAKING_CHANGES=()

# Simple diff check first
if diff -q /tmp/openapi-current.yaml /tmp/openapi-previous.yaml > /dev/null 2>&1; then
    log_success "No changes detected"
    echo ""
    echo "API specification is identical to previous version"
    echo "No version bump required"

    # Cleanup
    git worktree remove /tmp/canonical-previous 2>/dev/null
    rm -f /tmp/openapi-previous.yaml /tmp/openapi-current.yaml

    exit 0
fi

log_info "Changes detected - analyzing..."
echo ""

# Show diff
echo "Differences found:"
echo ""
diff -u /tmp/openapi-previous.yaml /tmp/openapi-current.yaml | head -%{std.string.from_number test_spec.output.max_diff_lines} | sed 's/^/  /'
echo ""

# Analyze changes (simplified detection)
# In a full implementation, this would parse YAML and do semantic analysis
# For now, we detect common patterns

log_section "Phase 4: Categorizing Changes"

# Check for removed endpoints (paths section)
if grep -q "^-.*paths:" /tmp/openapi-diff.txt 2>/dev/null || \
   diff /tmp/openapi-previous.yaml /tmp/openapi-current.yaml | grep -E "^<.*'/[a-zA-Z]+'" > /dev/null 2>&1; then
    BREAKING_CHANGES+=("Endpoints may have been removed")
fi

# Check for parameter changes
if diff /tmp/openapi-previous.yaml /tmp/openapi-current.yaml | grep -E "required:|type:" > /dev/null 2>&1; then
    log_warning "Parameter or type changes detected"
    echo "  Manual review required to determine if breaking"
fi

# Report findings
log_section "Phase 5: Analysis Results"

if [ ${#BREAKING_CHANGES[@]} -gt 0 ]; then
    log_error "POTENTIAL BREAKING CHANGES DETECTED"
    echo ""
    echo "The following changes may be breaking:"
    for change in "${BREAKING_CHANGES[@]}"; do
        echo "  - $change"
    done
    echo ""
    echo "Breaking changes include:"
    echo "  ❌ Removed endpoints"
    echo "  ❌ Removed required parameters"
    echo "  ❌ Changed parameter types"
    echo "  ❌ Changed response schemas"
    echo "  ❌ Optional parameters becoming required"
    echo ""
    echo "If confirmed as breaking:"
    echo "  - Requires MAJOR version bump (%{config.version} → X+1.0.0)"
    echo "  - Update CHANGELOG.md with migration guide"
    echo "  - Document breaking changes for users"
    echo ""

    RECOMMENDATION="MAJOR"
else
    log_info "No obvious breaking changes detected"
    echo ""
    echo "Changes appear to be non-breaking:"
    echo "  ✅ Added endpoints"
    echo "  ✅ Added optional parameters"
    echo "  ✅ Added response fields"
    echo "  ✅ Documentation updates"
    echo ""
    echo "Recommended version bump:"
    echo "  - MINOR for new features (%{config.version} → X.Y+1.0)"
    echo "  - PATCH for bug fixes (%{config.version} → X.Y.Z+1)"
    echo ""

    RECOMMENDATION="MINOR/PATCH"
fi

# Manual review reminder
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
log_info "Manual Review Required"
echo ""
echo "Automated detection is heuristic-based. Please:"
echo "  1. Review the diff above carefully"
echo "  2. Check if any changes affect existing clients"
echo "  3. Update version in src/config.ncl if needed"
echo "  4. Update CHANGELOG.md with changes"
echo "  5. Add migration guide if breaking changes confirmed"
echo ""
echo "Semantic Versioning:"
echo "  MAJOR (X.0.0) - Breaking changes"
echo "  MINOR (x.Y.0) - New features (backwards-compatible)"
echo "  PATCH (x.y.Z) - Bug fixes (backwards-compatible)"
echo ""
echo "Current version: %{config.version}"
echo "Recommended: $RECOMMENDATION version bump"
echo ""

# Cleanup
git worktree remove /tmp/canonical-previous 2>/dev/null
rm -f /tmp/openapi-previous.yaml /tmp/openapi-current.yaml /tmp/openapi-diff.txt

log_section "Regression Test Complete"

if [ ${#BREAKING_CHANGES[@]} -gt 0 ]; then
    log_warning "Review required - potential breaking changes detected"
    exit %{std.string.from_number test_spec.output.exit_code_on_breaking}
else
    log_success "No breaking changes detected"
    exit %{std.string.from_number test_spec.output.exit_code_on_non_breaking}
fi
  "%,
}
