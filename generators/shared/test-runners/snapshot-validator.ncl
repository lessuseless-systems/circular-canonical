# Circular Protocol Canonical - Snapshot Test Generator
# Generates shell script that compares current generator output against known-good snapshots
# Input: Configuration for generators to snapshot
# Output: dist/tests/snapshot-test.sh (generated snapshot validator)

let config = import "../../../src/config.ncl" in

# Generators to snapshot
let generators = [
  { name = "openapi.yaml", file = "generators/shared/openapi.ncl", format = "yaml" },
  { name = "typescript-sdk.ts", file = "generators/typescript/typescript-sdk.ncl", format = "raw" },
  { name = "python-sdk.py", file = "generators/python/python-sdk.ncl", format = "raw" },
  { name = "mcp-server.json", file = "generators/mcp-server.ncl", format = "json" },
] in

# Generate export command for a generator
let generate_export = fun gen =>
  m%"
if [ -f %{gen.file} ]; then
    nickel export %{gen.file} --format %{gen.format} > "$OUTPUT_DIR/%{gen.name}" 2>/dev/null || true
fi
  "%
in

# Generate all exports
let export_commands = std.string.join "\n" (
  std.array.map generate_export generators
) in

# Main script
{
  runner_script = m%"
#!/usr/bin/env bash
# Generator Snapshot Test Script
# Generated from generators/shared/test-runners/snapshot-validator.ncl
#
# âš ï¸  DO NOT EDIT THIS FILE MANUALLY
# To modify, edit the generator and regenerate
#
# Purpose: Compares current generator output against known-good snapshots
# Detects unintentional changes to generated artifacts

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ“¸ Generator Snapshot Tests${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "Version: %{config.version}"
echo ""

SNAPSHOT_DIR="tests/infrastructure/generators/snapshots"
OUTPUT_DIR="output"

# Check if snapshots exist
if [ ! -d "$SNAPSHOT_DIR" ] || [ -z "$(ls -A $SNAPSHOT_DIR 2>/dev/null)" ]; then
    echo -e "${YELLOW}âš  No snapshots found in $SNAPSHOT_DIR${NC}"
    echo ""
    echo "Create snapshots by running:"
    echo "  1. just generate"
    echo "  2. Verify output is correct"
    echo "  3. just update-snapshots"
    echo ""
    exit 0
fi

# Generate current outputs
echo "Generating current outputs..."
mkdir -p "$OUTPUT_DIR"

# Run generators (quietly)
%{export_commands}

echo ""

# Compare outputs with snapshots
PASSED=0
FAILED=0
CHANGED_FILES=""

for snapshot in "$SNAPSHOT_DIR"/*; do
    if [ ! -f "$snapshot" ]; then
        continue
    fi

    filename=$(basename "$snapshot")
    output_file="$OUTPUT_DIR/$filename"

    echo -n "Comparing $filename... "

    if [ ! -f "$output_file" ]; then
        echo -e "${YELLOW}âš  Missing${NC}"
        echo "  Output file not generated: $output_file"
        FAILED=$((FAILED + 1))
        CHANGED_FILES="$CHANGED_FILES\n  - $filename (missing)"
        continue
    fi

    # Compare files
    if diff -q "$snapshot" "$output_file" > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“ Match${NC}"
        PASSED=$((PASSED + 1))
    else
        echo -e "${RED}âœ— Changed${NC}"
        FAILED=$((FAILED + 1))
        CHANGED_FILES="$CHANGED_FILES\n  - $filename"

        # Show diff (first 20 lines)
        echo ""
        echo "  Diff (first 20 lines):"
        diff -u "$snapshot" "$output_file" | head -20 | sed 's/^/    /'
        echo ""
    fi
done

# Summary
TOTAL=$((PASSED + FAILED))
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ğŸ“Š Snapshot Test Results${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "Snapshot Tests: ${GREEN}$PASSED passed${NC}, ${RED}$FAILED failed${NC}"

if [ $FAILED -gt 0 ]; then
    echo ""
    echo -e "${RED}âœ— Generator output differs from snapshots${NC}"
    echo ""
    echo "Changed files:"
    echo -e "$CHANGED_FILES"
    echo ""
    echo "If these changes are intentional:"
    echo "  1. Review the differences carefully"
    echo "  2. Run: just update-snapshots"
    echo "  3. Commit the updated snapshots"
    echo ""
    exit 1
else
    echo ""
    echo -e "${GREEN}âœ“ All generator outputs match snapshots!${NC}"
    echo ""
    exit 0
fi
  "%,
}
