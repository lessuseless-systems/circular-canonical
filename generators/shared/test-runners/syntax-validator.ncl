# Circular Protocol Canonical - Syntax Validation Generator
# Generates shell script that validates generated SDK syntax
# Input: Configuration for which languages to validate
# Output: dist/tests/syntax-validation.sh (generated syntax validator)

let config = import "../../../src/config.ncl" in

# Languages to validate
let languages = [
  {
    name = "TypeScript",
    file = "dist/sdk/circular-protocol.ts",
    command = "npx tsc --noEmit",
    check_installed = "command -v npx",
  },
  {
    name = "Python",
    file = "dist/sdk/circular_protocol.py",
    command = "python3 -m py_compile",
    check_installed = "command -v python3",
  },
] in

# Generate validation command for a language
let generate_validation = fun lang =>
  m%"
# Validate %{lang.name}
echo -n "  Validating %{lang.name} SDK... "
if [ ! -f "%{lang.file}" ]; then
    echo "[SKIP] (file not found)"
else
    if %{lang.command} %{lang.file} > /dev/null 2>&1; then
        echo "[OK]"
        ((PASSED++))
    else
        echo "[FAIL]"
        ((FAILED++))
        FAILED_LANGS+=("%{lang.name}")
    fi
fi
  "%
in

# Generate all validations
let validations = std.string.join "\n" (
  std.array.map generate_validation languages
) in

# Total languages to validate
let total_langs = std.array.length languages in

# Main validator script
{
  validator_script = m%"
#!/usr/bin/env bash
# Syntax Validation for Generated SDKs
# Generated from generators/shared/test-runners/syntax-validator.ncl
#
# âš ï¸  DO NOT EDIT THIS FILE MANUALLY
# To modify, edit the generator and regenerate
#
# Purpose: Validate syntax of generated SDK code (Layer 2: syntax validation)
# Ensures generated code compiles without errors

set -euo pipefail

# Test counters
PASSED=0
FAILED=0
FAILED_LANGS=()

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” SDK Syntax Validation (Layer 2)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Version: %{config.version}"
echo "Languages: %{std.string.from_number total_langs}"
echo ""

# Run all validations
%{validations}

# Report results
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š Validation Results"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo -e "${GREEN}Passed:${NC} $PASSED/%{std.string.from_number total_langs}"
if [ $FAILED -gt 0 ]; then
    echo -e "${RED}Failed:${NC} $FAILED/%{std.string.from_number total_langs}"
    echo ""
    echo "Failed languages:"
    for lang in "${FAILED_LANGS[@]}"; do
        echo -e "  ${RED}âœ—${NC} $lang"
    done
    echo ""
    exit 1
else
    echo -e "${GREEN}âœ“ All SDKs have valid syntax!${NC}"
    echo ""
    exit 0
fi
  "%,
}
